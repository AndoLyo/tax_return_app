# Contributing to 確定申告支援アプリケーション

## コードレビューについて

このプロジェクトではCodeRabbit AIを使用してコードレビューを自動化しています。

> **注意**: AIレビューは補助的手段です。最終的な判断・承認責任は人間のレビューア/メンテナが負います。

#### AIレビュー利用上の禁止事項/推奨事項
- 機密情報の持ち込み禁止（APIキー、秘密鍵、認証トークン、実データ/確定申告書類、個人番号等）。ダミー化・マスキングを徹底。
- ログ/スクリーンショット/DBダンプ等の貼り付けは必ず匿名化・縮約し、本人特定情報を除去。
- セキュリティ関連コード（認証/認可/暗号/個人情報処理/課税ロジック）の変更は、人間レビューの最終承認が必須。
- 生成AIの提案を鵜呑みにせず、一次情報（公式ドキュメント/標準仕様）で検証してから取り込む。

### Pull Requestの作成

1. フィーチャーブランチを作成
2. 変更をコミット
3. Pull Requestを作成
4. CodeRabbitが自動的にレビューを開始

### コーディング規約

- **PEP 8 準拠 + 自動整形**: `black`、import整形: `isort`、静的解析: `ruff`
- **型ヒント必須**（公開関数/クラスは完全型注釈）。型チェック: `mypy --strict`
- **ドキュメント**: モジュール/公開APIへdocstring（Google/Numpyスタイルに統一）
- **セキュリティ**: `bandit` または `semgrep` によるスキャンをCIに組み込み
- **シークレット管理**: `.env` や秘密情報はコミット禁止（`git-secrets`/`trufflehog`で検出）
- **エラーハンドリング**: 外部I/O(API/DB/FS)は明示的例外処理＋リトライ/タイムアウト

#### ローカルチェック例
```bash
pip install -r requirements-dev.txt
ruff check .
black --check .
isort --check-only .
mypy .
pytest -q
```

### セキュリティと個人情報保護

- **収集最小化**: 不要な個人情報は保存しない。利用目的と保存期間をPRで明記
- **通信/保存暗号化**: TLS必須、保存時はKMS等で暗号化（鍵はKMS/Secret Managerで管理）
- **アクセス制御**: 最小権限の原則（RBAC）。監査ログを有効化
- **ログ方針**: 個人番号/氏名/住所/生年月日/収入額などはログ出力禁止。必要時はハッシュ化/マスキング
- **データ取り扱い**: 実データでのローカル検証禁止。サニタイズ済みサンプルデータを使用
- **依存関係**: `pip-audit` 等で脆弱性監査、SLA内で更新
- **脆弱性報告**: `SECURITY.md` の手順に従う（未整備の場合は本PRで追加）

### 機能追加のガイドライン

- **単体テストの追加**（最低カバレッジ目標: 行/分岐 80% 以上。回帰テストを同梱）
- **ドキュメントの更新**（ユーザー/開発者/運用。変更点・移行手順を明記）
- **既存機能への影響評価**（後方互換ポリシー/セマンティックバージョニングに従う）
- **パフォーマンスの最適化**（ベンチ指標と再現手順をPRに記載）
- **観測性の追加**（ログレベル/構造化ログ/メトリクス/トレーシングの更新）
- **機能フラグや段階的リリースの計画**（ロールアウトとロールバック手順）
- **i18n/アクセシビリティ配慮**（ユーザー向け表示/入力フォーム）

## レビュープロセス

1. CodeRabbitによる自動レビュー
2. 指摘事項への対応
3. 必要に応じて人間による追加レビュー
4. マージ前の最終確認

## 開発環境のセットアップ

### 前提条件
- Python 3.8以上
- Git
- pip

### セットアップ手順

1. リポジトリをクローン
```bash
git clone https://github.com/AndoLyo/tax_return_app.git
cd tax_return_app
```

2. 仮想環境を作成・有効化
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

3. 依存関係をインストール
```bash
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

4. pre-commitフックをセットアップ
```bash
pre-commit install
```

### 開発用コマンド

```bash
# コードフォーマット
black .
isort .

# 静的解析
ruff check .
mypy .

# テスト実行
pytest tests/ -v

# セキュリティチェック
bandit -r .
pip-audit

# カバレッジレポート
pytest tests/ --cov=tax_return_app --cov-report=html
```

## トラブルシューティング

### よくある問題

1. **MyPyエラー**: 型ヒントが不足している場合
   - 関数の引数と戻り値に適切な型ヒントを追加
   - `# type: ignore` コメントは最小限に

2. **Ruffエラー**: コードスタイルの問題
   - `ruff check --fix .` で自動修正
   - 手動で修正が必要な場合は適切なスタイルに変更

3. **テスト失敗**: 新機能追加時のテスト不足
   - 新機能に対応するテストケースを追加
   - 既存テストの更新が必要な場合は慎重に確認

## コミットメッセージの規約

### 形式
```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

### タイプ
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント更新
- `style`: コードスタイル修正
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: その他の変更

### 例
```
feat(calculator): 所得税計算機能を追加

- 給与所得控除の自動計算
- 基礎控除の適用
- 税率表による税額算出

Closes #123
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。貢献する際は、このライセンスに同意したものとみなされます。